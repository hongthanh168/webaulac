@model dynamic
@{
    ViewBag.Title = "Danh sách quyết định công tác theo tháng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section huongdan{
    <text>Thống kê danh sách quyết định công tác theo tháng</text>
}
@{
//IEnumerable<WebAuLac.Models.HRM_EMPLOYMENTHISTORY> bangKe = (IEnumerable<WebAuLac.Models.HRM_EMPLOYMENTHISTORY>)ViewBag.BangKe;
}
@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-inline">
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        <div class="row" style="text-align:center; margin-bottom:15px;">

            <div class="form-group">
                @Html.DropDownList("Thang",null, htmlAttributes: new { @class = "form-control" })
                @Html.DropDownList("Nam", null, htmlAttributes: new { @class = "form-control" })
            </div>
            <div class="form-group">
                <div>
                    <button class="btn btn-success" type="submit" value="xemthongtin" name="answer">
                        <i class="fa fa-calculator"></i> Xem thông tin
                    </button>
                    <button class="btn btn-success" type="submit" value="layluongcoban" name="answer">
                        <i class="fa fa-calculator"></i> Lấy lương cơ bản
                    </button>

                    @if (User.IsInRole("Create") && User.IsInRole("HR"))
                    {
                        <div class="form-group">
                            <button id="btnLuu" class="btn btn-success"><i class="fa fa-file-excel-o m-right-xs"></i>Lưu quá trình công tác gốc</button>
                        </div>
                        <div class="form-group">
                            <button id="btnHuy" class="btn btn-success"><i class="fa fa-file-excel-o m-right-xs"></i>Hủy quá trình công tác gốc</button>
                        </div>
                    }                   

                </div>
            </div>
        </div>


    </div>
}
@*@if (bangKe != null)
{*@
    <table class="display table table-striped jambo_table border-right action-table" id="bangKe">
        <thead>
            <tr>
                <th></th>
                <th>
                    Họ tên
                </th>
                <th>
                    Số QĐ
                </th>
                <th>
                    Ngày QĐ
                </th>
                <th>
                   Ngày XT
                </th>
                <th>
                   PB/Tàu
                </th>
                <th>
                   Chức danh
                </th>
                <th>
                   %Lương
                </th>
                <th>
                    Lương CB
                </th>
                <th>
                   PCTN
                </th>
                <th>
                  Thỏa thuận
                </th>
               
               <th></th>
                
            </tr>

        </thead>
        <tbody>
            @foreach (dynamic item in Model)
            {
                string rowID = @item.EmploymentHistoryID.ToString();
                <tr id="@rowID" class="@(item.TH ? "co" : "khong")">
                @*<tr id="@rowID">*@
                    <td></td>
                    <td>
                        @{
                            string hoTen = item.FirstName + " " + item.LastName;
                        }
                        <text>@hoTen</text>
                    </td>
                    <td>@item.DecisionNo</td>
                    <td>
                        @*@Html.DisplayFor(modelItem => item.DecisionDate)*@
                        @if (item.DecisionDate != null)
                        {
                            @item.DecisionDate.ToString("dd/MM/yyyy");
                        }
                  
                    </td>
                    <td>
                        @*@Html.DisplayFor(modelItem => item.NgayXuongTau*@
                       @if (item.NgayXuongTau != null)
                       { @item.NgayXuongTau.ToString("dd/MM/yyyy"); }
                    </td>
                    <td>
                        @*@Html.DisplayFor(modelItem => item.DIC_DEPARTMENT.DepartmentName)*@
                        @item.DepartmentName
                    </td>
                    <td>
                        @*@Html.DisplayFor(modelItem => item.DIC_POSITION.PositionName)*@
                        @item.PositionName
                    </td>
                     
                    <td>
                        @*@Html.DisplayFor(modelItem => item.PerPosition)*@
                        @item.PerPosition
                    </td>
                    <td>
                        @*@Html.DisplayFor(modelItem => item.DIC_SALARY.Salary)*@
                        @*@item.Salary*@
                        
                        @{
                            string salary = @item.Salary.ToString("#,000");
                            if (item.Salary == 0)
                                salary= "";
                        }
                        <text>@salary</text>
                 

                    </td>
                    <td>
                        @*@Html.DisplayFor(modelItem => item.AllowanceSalary)*@
                        @*@item.AllowanceSalary*@

                        @{
                            string allowancesalary = @item.AllowanceSalary.ToString("#,000");
                            if (item.AllowanceSalary == 0)                            
                                allowancesalary = "";
                            
                        }
                        <text>@allowancesalary</text>



                    </td>
                    <td>
                        @*@Html.DisplayFor(modelItem => item.Bonus)*@
                        @*@item.Bonus*@

                        @{
                            string bonus = item.Bonus.ToString("#,000");
                            if (item.Bonus == 0)
                            {
                                bonus = "";
                            }

                        }
                        <text>@bonus</text>


                    </td>
                   
                   
                   
                    <td>
                        @*@Html.DisplayFor(modelItem => item.EmploymentHistoryID)*@
                        @item.EmploymentHistoryID
                    </td>
                   
                </tr>
            }
        </tbody>
    </table>
 
@section Styles{
    @Styles.Render("~/vendors/DataTables/css")
    @Styles.Render("~/vendors/DataTables/Buttons/css")
    <style>
    .co {
        color: black !important;
        /*background: yellow !important;*/
    }

    .khong {
        color: red !important;
        /*background: violet !important;*/
    }
</style>

}
@section scripts{
    @Scripts.Render("~/vendors/DataTables/js")
    @Scripts.Render("~/vendors/DataTables/Buttons/js")
    @Scripts.Render("~/bundles/jqueryval")
    <!--modal form-->
    @Scripts.Render("~/bundles/modalform")
    
    <script language="javascript">

            $(document).ready(function () {
                //var t = $('#EmployeesList1').DataTable({
                //    "language": {
                //        "url": "/vendors/DataTables/langs/Vietnamese.json"
                //    },
                //    "columnDefs": [{
                //        "searchable": false,
                //        "orderable": false,
                //        "targets": 0
                //    },

                //    {
                //        "searchable": false,
                //        "orderable": false,
                //        "targets": 5
                //    },
                //     {

                //         "visible": false,
                //         "targets": 10
                //     },
                //    ]
                //});
                //t.on('order.dt search.dt', function () {
                //    t.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                //        cell.innerHTML = i + 1;
                //    });
                //}).draw();
                // Setup - add a text input to each footer cell


                    // DataTable
                var table = $('#bangKe').DataTable({

                    "columnDefs": [{
                        "searchable": false,
                        "orderable": false,
                        "className": 'select-checkbox',
                        "targets": 0
                    },

                                     {

                                         "visible": false,
                                         "targets": 17
                                     },
                    ],
                    "select": {
                        "style": 'os',
                        "selector": 'td:first-child'
                    }
                });




                //Nut chọn
                    $('#btnLuu').click(function () {
                        var listEmployeeID =[];
                        //alert(table.rows('.selected').data().length + ' row(s) selected');
                        var count=0;
                             $.each(table.rows('.selected').data(), function () {
                                 listEmployeeID[count] = this[17];
                                 //alert(listEmployeeID[count]);
                                 count++;

                             });
                             $.ajax({
                                 type: "POST",
                                 traditional: true,
                                 url: '@Url.Action("LuuQTCT", "HRM_EMPLOYMENTHISTORY_GOC")',
                                 data: JSON.stringify({function_param: listEmployeeID }),
                                 contentType: "application/json; charset=utf-8",
                                 async: true,
                                 cache: false,
                                 success: function (data) {
                                     //get the file name for download

                                          //use window.location.href for redirect to download action for download the file
                                            @*window.location.href = "@Url.RouteUrl(new
                                { Controller = "HRM_EMPLOYMENTHISTORY_GOC", Action = "Index"})/?";*@
                                     document.location.reload()

                                 },
                                 error: function () {
                                     if (data.success == true) { // if true (1)
                                         setTimeout(function () {// wait for 5 secs(2)
                                             location.reload(); // then reload the page.(3)
                                         }, 5000);
                                     }
                                     //alert("Có lỗi xảy ra");
                                 }
                             });
                        @*$.ajax({
                            type: "POST",
                            url: '@Url.Action("XuatBaoCaoTest", "HRM_bangcaphethan")',
                            data: JSON.stringify({ function_param: listEmployeeID }),
                             contentType: "application/json; charset=utf-8",
                            dataType: "json",
                        }).done(function (data) {
                            //console.log(data.result);
                            $.unblockUI();

                            //get the file name for download
                            if (data.fileName != "") {
                                //use window.location.href for redirect to download action for download the file
                                window.location.href = "@Url.RouteUrl(new
                                { Controller = "HRM_bangcaphethan", Action = "Download"})/?file=" + data.fileName;
                                }
                        });*@
                        //var ids = $.map(table.rows('.selected').data(), function (item) {
                        //    return item[1];
                        //});
                        //alert(ids);

                       // alert(table.rows('.selected').data().length + ' row(s) selected');
                    });
                //Hủy QTCT gốc
                $('#btnHuy').click(function () {
                    var listEmployeeID =[];
                    //alert(table.rows('.selected').data().length + ' row(s) selected');
                    var count=0;
                    $.each(table.rows('.selected').data(), function () {
                        listEmployeeID[count] = this[16];
                        //alert(listEmployeeID[count]);
                        count++;

                    });
                    $.ajax({
                        type: "POST",
                        traditional: true,
                        url: '@Url.Action("HuyQTCT", "HRM_EMPLOYMENTHISTORY_GOC")',
                        data: JSON.stringify({function_param: listEmployeeID }),
                        contentType: "application/json; charset=utf-8",
                        async: true,
                        cache: false,
                        success: function (data) {
                            document.location.reload();
                            //get the file name for download
                            @*if (data.fileName != "") {
                                //use window.location.href for redirect to download action for download the file
                                window.location.href = "@Url.RouteUrl(new
                                { Controller = "HRM_bangcaphethan", Action = "Download"})/?file=" + data.fileName;
                                }*@
                                },
                        error: function () {
                            //alert("Có lỗi xảy ra");
                        }
                    });
                        @*$.ajax({
                            type: "POST",
                            url: '@Url.Action("XuatBaoCaoTest", "HRM_bangcaphethan")',
                            data: JSON.stringify({ function_param: listEmployeeID }),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                        }).done(function (data) {
                            //console.log(data.result);
                            $.unblockUI();

                            //get the file name for download
                            if (data.fileName != "") {
                                //use window.location.href for redirect to download action for download the file
                                window.location.href = "@Url.RouteUrl(new
                                { Controller = "HRM_bangcaphethan", Action = "Download"})/?file=" + data.fileName;
                                }
                        });*@
                    //var ids = $.map(table.rows('.selected').data(), function (item) {
                    //    return item[1];
                    //});
                    //alert(ids);

                    // alert(table.rows('.selected').data().length + ' row(s) selected');
                        });
                });

    </script>
}
